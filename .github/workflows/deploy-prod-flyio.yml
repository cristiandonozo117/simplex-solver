name: CI/CD · Build · CodeQL · GHCR · Fly.io · Discord

on:
  push:
    branches: ["main", "master"]

env:
  VERSION: v1.1.${{ github.run_number }}
  GHCR_OWNER: ${{ github.repository_owner }}
  BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/simplex-backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository_owner }}/simplex-frontend
  BACKEND_SERVICE: simplex-solver-backend
  FRONTEND_SERVICE: simplex-solver-frontend

permissions:
  contents: read
  packages: write
  security-events: write
  id-token: write

jobs:
  # =========================================================
  # 1️⃣ CODEQL ANALYSIS
  # =========================================================
  codeql:
    name: Static Analysis (CodeQL)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: python, javascript
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  # =========================================================
  # 2️⃣ BACKEND TESTS
  # =========================================================
  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-24.04
    needs: codeql
    defaults:
      run:
        shell: bash
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run pytest
        run: pytest -q
      - name: Run manual test
        run: python -m tests.test_manual

  # =========================================================
  # 3️⃣ BUILD & PUSH IMAGES
  # =========================================================
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-24.04
    needs: backend-tests
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      # --- Build Backend ---
      - name: Build & Push Backend Image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:${{ env.VERSION }}

      # --- Build Frontend ---
      - name: Build & Push Frontend Image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:${{ env.VERSION }}
          build-args: |
            NGINX_CONF=nginx_fly_io.conf

  # =========================================================
  # 4️⃣ DEPLOY TO FLY.IO
  # =========================================================
  deploy-flyio:
    name: Deploy to Fly.io
    runs-on: ubuntu-24.04
    needs: build-and-push
    steps:
      - uses: actions/checkout@v4

      - name: Instalar Flyctl manualmente
        run: |
          curl -L https://fly.io/install.sh | sh
          echo "$HOME/.fly/bin" >> $GITHUB_PATH

      - name: Deploy Backend en Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          fly deploy \
            --image "${{ env.BACKEND_IMAGE }}:${{ env.VERSION }}" \
            --config backend/fly.toml \
            --app simplex-solver-backend \
            --remote-only

      - name: Deploy Frontend en Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          fly deploy \
            --image "${{ env.FRONTEND_IMAGE }}:${{ env.VERSION }}" \
            --config frontend/fly.toml \
            --app simplex-solver-frontend \
            --remote-only

  # =========================================================
  # 5️⃣ DISCORD NOTIFICATION
  # =========================================================
  notify:
    name: Discord Notification
    runs-on: ubuntu-24.04
    needs: [codeql, backend-tests, build-and-push, deploy-flyio]
    if: always()
    steps:
      - name: Send status to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ "${{ needs.codeql.result }}" = "success" ] && \
            [ "${{ needs.backend-tests.result }}" = "success" ] && \
            [ "${{ needs.build-and-push.result }}" = "success" ] && \
            [ "${{ needs.deploy-flyio.result }}" = "success" ]; then
            STATUS="success"
            COLOR=3066993
            TITLE="✅ CI/CD Success"
            DESCRIPTION="All jobs completed successfully"
          else
            STATUS="failure"
            COLOR=15158332
            TITLE="❌ CI/CD Failed"
            DESCRIPTION="One or more jobs failed"
          fi

          REPO="${{ github.repository }}"
          URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          VERSION="${{ env.VERSION }}"

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "$TITLE",
              "description": "$DESCRIPTION\n**Repo:** $REPO\n**Version:** $VERSION\n**Workflow:** ${{ github.workflow }}",
              "url": "$URL",
              "color": $COLOR,
              "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
              "fields": [
                {"name": "CodeQL", "value": "${{ needs.codeql.result }}", "inline": true},
                {"name": "Backend Tests", "value": "${{ needs.backend-tests.result }}", "inline": true},
                {"name": "Build & Push", "value": "${{ needs.build-and-push.result }}", "inline": true},
                {"name": "Deploy to Fly.io", "value": "${{ needs.deploy-flyio.result }}", "inline": true}
              ]
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "$DISCORD_WEBHOOK"
